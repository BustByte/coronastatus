<!DOCTYPE html>
<html>
    <head>
        <%- include('partials/head') -%>
        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <script src="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js"></script>
        <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css" rel="stylesheet" />
        <style>
            #map { position: fixed; width: 100%; height: 100% }
        </style>
    </head>
    <body>
        <style>
            .map-overlay {
                font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
                position: absolute;
                width: 7%;
                min-width: 150px;
                top: 100px;
                left: 0;
                padding: 10px;
            }

            .map-overlay .map-overlay-labels {
                background-color: #fff;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                min-width: 140px;
                border-radius: 3px;
                padding: 10px;
                margin-bottom: 10px;
            }

            .map-overlay .map-overlay-info {
                background-color: #fff;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                min-width: 140px;
                border-radius: 3px;
                padding: 10px;
                margin-bottom: 10px;
            }

            @media screen and (max-width: 1024px) {
                .map-overlay-info {
                    display: none !important;
                }
            }

            .map-overlay-bottom {
                font: 11px Arial;
                color: #fff;
                position: fixed;
                height: 40px;
                bottom: 5px;
                right: 10px;
            }

            .map-overlay .legend .healthy {
                height: 10px;
                width: 100%;
                background:  linear-gradient(to right, #91cf60, #91cf60);
            }

            .map-overlay .legend .positive {
                height: 10px;
                width: 100%;
                background:  linear-gradient(to right, #fc8d59, #fc8d59);
            }

            .map-overlay .legend .symptoms {
                height: 10px;
                width: 100%;
                background:  linear-gradient(to right, #ffffbf, #ffffbf);
            }

            .logo__text {
                color: #fff;
            }

            a {
                color: #fff;
            }
        </style>
        <div id="map"></div>
        <%- include('partials/menu') -%>
        <div class="map-overlay top">
            <div class="map-overlay-info">
                <h5>Rapportert status per postnummer</h5>
                <p>Posisjonene vist samsvarer med gitte koordinater per postnummer, og har ingenting med enkeltpersoner og gjøre.<p>
                <label id="month"></label>
            </div>
            <div class="map-overlay-labels">
                <div id="legend" class="legend">
                    <div>Frisk</div>
                    <div class="healthy"></div>
                    <div>Har symptomer</div>
                    <div class="symptoms"></div>
                    <div>Testet positivt</div>
                    <div class="positive"></div>
                </div>
            </div>
        </div>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoiZnJlZHJpa3BlIiwiYSI6ImNrN3QxOGV4bTBuNmwzbG1yNnUzMXIyaWMifQ._pfjKIPQuSFRxSCv8oRLEA';
            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v10',
                center: [10.7522, 63.9139],
                zoom: 4,
                attributionControl: false,
                hash: true
            });

            function Attributions() { }
            Attributions.prototype.onAdd = function(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.className = 'mapboxgl-ctrl';
                this._container.innerHTML = "<a href='http://www.erikbolstad.no/geo/noreg/postnummer/'>postnummerinfo</a>" +
                    " © <a href='https://www.mapbox.com/about/maps/'>Mapbox</a>" +
                    " © <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>";
                return this._container;
            };
            Attributions.prototype.onRemove = function () {
                 this._container.parentNode.removeChild(this._container);
                 this._map = undefined;
            };
            var attributions = new Attributions();

            map.on('load', function(){
                map.addControl(attributions, 'bottom-right');
            });

            const positive = ['==', ['get', 'state'], 'POSITIVE'];
            const symptoms = ['==', ['get', 'state'], 'SYMPTOMS'];
            const healthy = ['==', ['get', 'state'], 'HEALTHY'];

            const colors = {
                positive: "#fc8d59",
                symptoms: "#ffffbf",
                healthy: "#91cf60"
            };

            map.on('load', function() {
                map.addSource('reports', {
                  'type': 'geojson',
                  data: '/kart/geojson',
                  cluster: true,
                  clusterMaxZoom: 100, // Max zoom to cluster points on
                  clusterRadius: 80,
                  clusterProperties: {
                    positive: ['+', ['case', positive, 1, 0]],
                    symptoms: ['+', ['case', symptoms, 1, 0]],
                    healthy: ['+', ['case', healthy, 1, 0]],
                  }
                });

                map.addLayer({
                  'id': 'report_individual',
                  'type': 'circle',
                  'source': 'reports',
                  'filter': ['!=', ['get', 'cluster'], true],
                  'paint': {
                    'circle-color': ['case',
                      positive, colors.positive,
                      symptoms, colors.symptoms,
                      healthy, colors.healthy,
                      "#000000"
                    ],
                    // We do not show these single points at all. They are only here
                    // because the markers wouldn't render without.
                    'circle-radius': 0
                  }
                });
            });

            let markers = {};
            let markersOnScreen = {};
            let point_counts = [];
            let totals;

            const getPointCount = (features) => {
              features.forEach(f => {
                if (f.properties.cluster) {
                  point_counts.push(f.properties.point_count)
                }
              })
              return point_counts;
            };

            const updateMarkers = () => {
              let newMarkers = {};
              const features = map.querySourceFeatures('reports');
              totals = getPointCount(features);
              features.forEach((feature) => {
                const coordinates = feature.geometry.coordinates;
                const props = feature.properties;
                if (!props.cluster) {
                  return;
                };
                const id = props.cluster_id;
                let marker = markers[id];
                if (!marker) {
                  const el = createDonutChart(props, totals);
                  marker = markers[id] = new mapboxgl.Marker({
                    element: el
                  }).setLngLat(coordinates);
                }

                newMarkers[id] = marker;

                if (!markersOnScreen[id]) {
                  marker.addTo(map);
                }
              });

              for (id in markersOnScreen) {
                if (!newMarkers[id]) {
                  markersOnScreen[id].remove();
                }
              }
                markersOnScreen = newMarkers;
            };

            const createDonutChart = (props, totals) => {
              const div = document.createElement('div');

              const data = [
                {type: 'positive', count: props.positive},
                {type: 'symptoms', count: props.symptoms},
                {type: 'healthy', count: props.healthy},
              ];

              const thickness = 10;

              // this sets the scale for our circle radius
              // and this is why we need the totals. We need to
              // set a mininum and a maximum to define the domain and the range.
              const scale = d3.scaleLinear()
                .domain([d3.max(totals), d3.min(totals)])
                .range([1000, d3.max(totals)])

              const radius = Math.sqrt(scale(props.point_count)) + 10;
              const circleRadius = radius - thickness;

              const svg = d3.select(div)
                .append('svg')
                .attr('class', 'pie')
                .attr('width', radius * 2)
                .attr('height', radius * 2);

              const g = svg.append('g')
                .attr('transform', `translate(${radius}, ${radius})`);

              const arc = d3.arc()
                .innerRadius(radius - thickness)
                .outerRadius(radius);

              const pie = d3.pie()
                .value(d => d.count)
                .sort(null);

              const path = g.selectAll('path')
                .data(pie(data.sort((x, y) => d3.ascending(y.count, x.count))))
                .enter()
                .append('path')
                .attr('d', arc)
                    .attr('fill', (d) => colors[d.data.type])

              const circle = g.append('circle')
                .attr('r', circleRadius)
                .attr('fill', 'rgba(0, 0, 0, 0.7)')
                .attr('class', 'center-circle')

              const text = g
                .append("text")
                .attr("class", "total")
                .text(props.point_count_abbreviated)
                .attr('text-anchor', 'middle')
                .attr('dy', 5)
                .attr('fill', 'white')

              return div;
            }

            map.on('data', (e) => {
              if (e.sourceId !== 'reports' || !e.isSourceLoaded) return;

              map.on('move', updateMarkers);
              map.on('moveend', updateMarkers);
              updateMarkers();
            });

            map.addControl(new mapboxgl.NavigationControl());
        </script>
    </body>
</html>
